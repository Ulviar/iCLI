# Analysis Log — ICLI-031 — 2025-11-04

- **Author:** Assistant
- **Lifecycle stage:** Analysis
- **Context:** Establish scope and verification approach for the pooled client integration coverage requested in the
  backlog.

## Knowledge consulted
- [context/tasks/backlog.md](../backlog.md) — Confirmed ICLI-031 goals (run `ProcessPoolClient` against the real pool
  with multi-worker configs) and constraints (reuse existing integration fixtures).
- [context/tasks/archive/ICLI-016/README.md](../archive/ICLI-016/README.md) — Reviewed why ProcessPoolClient exists,
  pending risks (integration + stress coverage), and how listener hooks are expected to behave; clarified what scenarios
  must be exercised.
- [context/roadmap/process-pool-architecture.md](/context/roadmap/process-pool-architecture.md) — Re-read pool sizing,
  reset, and shutdown semantics to ensure the integration test config exercises multi-worker reuse and retirement
  accurately.
- [context/knowledge-base/operations/Java Terminal & Process
  Integration.md](/context/knowledge-base/operations/Java%20Terminal%20%26%20Process%20Integration.md) — Revisited
  guidance on deterministic process fixtures and PTY expectations to avoid flaky integration scenarios.

## Repository inspection
- `src/main/java/com/github/ulviar/icli/client/pooled/ProcessPoolClient.java`, `ServiceProcessor.java`,
  `ServiceConversation.java` — Verified how leases are acquired, resets triggered, and listeners notified; identified
  behaviours worth asserting in integration tests (stateless processor success/failure, manual reset on retire).
- `src/main/java/com/github/ulviar/icli/engine/pool/api/ProcessPool.java` and `ProcessPoolConfig.java` — Confirmed
  builder knobs (min/max size, timeouts) needed to spin up multiple workers quickly within tests.
- `src/test/kotlin/com/github/ulviar/icli/client/pooled/ProcessPoolClientTest.kt` — Noted current coverage relies on
  fakes; helps map which behaviours still need real-engine verification (true concurrency, reset hooks, drain
  semantics).
- `src/integrationTest/kotlin/com/github/ulviar/icli/engine/pool/api/ProcessPoolIntegrationTest.kt` and
  `client/LineSessionClientIntegrationTest.kt` — Studied existing integration patterns (using `StandardProcessEngine` +
  `TestProcessCommand`) and helper utilities for reading deterministic output.
- `src/integrationTest/kotlin/com/github/ulviar/icli/testing/TestProcessCommand.kt` and
  `src/test/kotlin/com/github/ulviar/icli/testing/processes/TestProcess.kt` — Evaluated which command flags best fit
  pooled line processing; `--echo-stdin` avoids the “READY” handshake, simplifying stateless processor assertions.

## Gaps & questions
- Need to prove multi-worker behaviour without relying on arbitrary sleeps. Approach: configure `minSize = maxSize = 2`,
  submit concurrent requests via `CompletableFuture`, and assert outputs complete even when both workers busy.
- Listener verification: integration tests should assert listener callbacks fire in real scenarios, but collecting
  events requires thread-safe recorder similar to unit tests; plan to reuse/test-only recorder.
- Confirm how to trigger graceful shutdown within integration test (closing `ProcessPoolClient` and expecting drain
  success) without leaving stray processes.

## Decision / readiness
- Ready to implement. The plan is to add a new integration test class under
  `src/integrationTest/kotlin/com/github/ulviar/icli/client/pooled/` that:
  1. Configures a real `ProcessPoolClient` + `StandardProcessEngine` with `TestProcessCommand --echo-stdin`.
  2. Covers stateless requests, concurrent multi-worker usage, and conversation leasing/retirement.
  3. Records listener callbacks to assert sequencing.

## Next steps
1. Create the integration test suite and supporting recorder/utilities (Kotlin).
2. Update backlog entry to link this dossier and mark the task active.
3. Run the integration tests via Gradle (`run_gradle_tests` for `integrationTest`) plus Spotless as required.
4. Capture execution history with observed failures/successes and refresh `.commit-message`.
