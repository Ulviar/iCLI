# Execution Plan — ICLI-015 — 2025-10-28

- **Author:** Assistant
- **Lifecycle stage:** Execution
- **Context:** Plan out the deeper ProcessPool refactor

## Objectives
- Partition the existing `PoolState` responsibilities into smaller, testable collaborators with clear invariants.
- Eliminate lock-held diagnostics side effects and ensure lease timeouts flow through the standard release pipeline.
- Preserve existing pool behaviours (queue bounds, retirement policies, drain semantics) while improving determinism and
  testability.

## Work plan
1. **Define new state collaborators.**
   - Introduce `LifecycleGate`, `WaiterQueue`, and `CapacityLedger` (plus supporting metric delta types) to capture
   lifecycle flags, waiter handoff, and worker accounting separately.
   - Document invariants for each class (e.g., lifecycle transitions, handoff fairness, active/launching/idle
   relationships).
2. **Refactor `PoolState`.**
   - Rebuild `PoolState` to compose the new collaborators, returning explicit state deltas/events instead of firing
   diagnostics under lock.
   - Encode assertion checks under the lock to guard invariants in debug-friendly code paths.
3. **Update `ProcessPool`.**
   - Adjust acquisition, launch, and release flows to consume the new state APIs, perform diagnostics/metrics publishing
   after lock exit, and enforce the queue handoff strategy.
   - Route lease timeouts through the unified release logic (triggering retirement decisions and counter updates
   correctly).
4. **Revise tests.**
   - Add focused unit tests for `LifecycleGate`, `WaiterQueue`, and `CapacityLedger`.
   - Update existing pool unit/integration tests to the new acquisition/release semantics (including timeout-driven
   retirement and waiter fairness).
5. **Verification & cleanup.**
   - Run `gradle test`, `gradle integrationTest`, and Spotless/SpotBugs tasks.
   - Refresh dossier notes and `.commit-message` once the refactor diff stabilises.

## Open considerations
- Decide whether to keep the current metrics aggregation inside `PoolInventory` or migrate it into the new ledger while
  avoiding duplication.
- Evaluate if additional diagnostics events are required once handoff fairness is in place (e.g., explicit waiter wake
  notifications).
