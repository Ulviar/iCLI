# Execution History — ICLI-015 — 2025-10-28

- **Author:** Assistant
- **Lifecycle stage:** Execution
- **Summary:** Introduced the ProcessPool runtime, configuration surface, and unit tests validating leasing and reuse
  semantics.

## Implementation notes
- Added core pool package with `ProcessPool`, `ProcessPoolConfig`, and supporting types for leases, reset hooks,
  diagnostics, and service exceptions (`src/main/java/com/github/ulviar/icli/core/pool/*`).
- Exported the new pool package from the Java module descriptor (`src/main/java/module-info.java`).
- Extended the runtime to enforce queue depth limits, idle eviction, worker lifetime retirement, minimum-size
  replenishment, and diagnostics on launch failures (`src/main/java/com/github/ulviar/icli/core/pool/ProcessPool.java`).
- Added request-timeout enforcement with lease-level deadlines and richer diagnostics callbacks/metrics snapshots
  (`src/main/java/com/github/ulviar/icli/core/pool/ProcessPool.java`,
  `src/main/java/com/github/ulviar/icli/core/pool/PoolDiagnosticsListener.java`,
  `src/main/java/com/github/ulviar/icli/core/pool/PoolMetrics.java`).
- Expanded Kotlin-based unit coverage to include queue overflows, idle eviction, lifetime retirement, minimum-size
  replenishment, and lease timeout behaviour alongside pre-warm/reuse checks
  (`src/test/kotlin/com/github/ulviar/icli/core/pool/ProcessPoolTest.kt`).
- Added integration smoke tests covering interactive replenishment and request timeout behaviour
  (`src/integrationTest/kotlin/com/github/ulviar/icli/core/pool/ProcessPoolIntegrationTest.kt`).

## Tests & verification
- `gradle test` — Passed via `run_gradle_tests`.
- `gradle spotlessApply` — Applied formatting successfully.
- `gradle spotbugsMain` — Completed without findings after addressing dead-code warning.

## Documentation updates
- Updated backlog entry and maintained task dossier metadata under `context/tasks/ICLI-015`.

## Follow-up & risks
- Pool reset hooks currently execute synchronously and default hooks remain to be implemented; future tasks should
  extend coverage once ProcessPoolClient lands.
- Surface pool metrics through higher-level diagnostics and expose configurable reset hook defaults in follow-up tasks.

## Retrospective & process improvement
- Work meets the current Definition of Done; next iteration should attach integration tests once request-level APIs are
  available.
- Workflow improvement: codify reusable fake `InteractiveSession` fixtures to simplify additional pool tests.

## Links
- [context/tasks/ICLI-015/README.md](../../ICLI-015/README.md)

---

- **Author:** Assistant
- **Lifecycle stage:** Execution
- **Summary:** Split ProcessPool responsibilities into dedicated collaborators, introduced a pluggable lease timeout
  scheduler, and expanded multithreaded test coverage to improve determinism.

## Implementation notes
- Replaced the ad-hoc `LeaseDeadlineTracker` with a configurable `LeaseTimeoutScheduler` abstraction and provided the
  default implementation backed by a scheduled executor plus a builder hook in `ProcessPoolConfig`.
- Added `ResetHookRunner` and `WorkerRetirementPolicy` to encapsulate reset execution and retirement thresholds,
  reducing `ProcessPool` surface area and clarifying concurrency boundaries.
- Updated `ProcessPool` to rely on the new collaborators, ensure schedulers close during drain, and reuse the injected
  timeout scheduler for deterministic tests.
- Simplified integration and unit tests by wiring manual timeout schedulers, added a blocking acquisition regression
  test, and introduced focused unit coverage for the new collaborators.

## Tests & verification
- `gradle test`
- `gradle integrationTest`
- `gradle spotlessApply`
- `gradle spotbugsMain`

## Documentation updates
- Recorded the additional execution history for ICLI-015 (this file).

## Follow-up & risks
- Manual timeout scheduler helpers live inside tests; consider extracting shared fixtures if future tasks require reuse
  across source sets.

## Retrospective & process improvement
- Deterministic schedulers materially improved test speed and reliability; future timeout-related work should follow the
  same pattern before introducing real sleeps.

## Links
- `src/main/java/com/github/ulviar/icli/core/pool/ProcessPool.java`
- `src/main/java/com/github/ulviar/icli/core/pool/LeaseTimeoutScheduler.java`
- `src/test/kotlin/com/github/ulviar/icli/core/pool/ProcessPoolTest.kt`

---

- **Author:** Assistant
- **Lifecycle stage:** Execution
- **Summary:** Applied fixes by eliminating the timeout race, enforcing FIFO fairness when idle workers exist, and 
  preventing minimum-size replenishment after `close()`. Expanded unit coverage to lock these behaviours down.

## Implementation notes
- Registered active leases before starting request deadlines so synchronous schedulers cannot fire before
  `DefaultWorkerLease` construction (`ProcessPool.java:61`).
- Updated `PoolState.acquire` to hand idle workers to queued waiters, preserving FIFO order even under contention, and
  added lifecycle guards around `reserveForMinimum` so closing pools stop launching replacements (`PoolState.java:62`,
  `PoolState.java:229`).
- Added Kotlin tests covering `close()` prewarm suppression and eager timeout scheduling, plus an eager test scheduler
  and diagnostics tracking for timeout events (`ProcessPoolTest.kt:102`, `ProcessPoolTest.kt:303`,
  `ProcessPoolTest.kt:629`).

## Tests & verification
- `gradle test`
- `gradle spotlessApply`

## Follow-up & risks
- Fairness tests rely on the deterministic fake scheduler and current queue implementation; if we later swap to a
  different waiter strategy, refresh the coverage to ensure it still captures barging cases.

## Retrospective & process improvement
- Writing the eager timeout test caught the race reliably; keep using adversarial schedulers whenever we introduce new
  concurrency primitives.

## Links
- `src/main/java/com/github/ulviar/icli/core/pool/ProcessPool.java:68`
- `src/main/java/com/github/ulviar/icli/core/pool/PoolState.java:41`
- `src/main/java/com/github/ulviar/icli/core/pool/PoolState.java:253`
- `src/test/kotlin/com/github/ulviar/icli/core/pool/ProcessPoolTest.kt:100`
- `src/test/kotlin/com/github/ulviar/icli/core/pool/ProcessPoolTest.kt:325`
- `src/test/kotlin/com/github/ulviar/icli/core/pool/ProcessPoolTest.kt:639`

---

- **Author:** Assistant
- **Lifecycle stage:** Execution
- **Summary:** Replaced the remaining intrinsic monitor logic with a dedicated `PoolState` concurrency coordinator to
  simplify `ProcessPool` state management and remove `wait/notify`.

## Implementation notes
- Added `PoolState` to own all mutable pool counters and synchronisation using a fair `ReentrantLock`/`Condition`
  pairing, encapsulating queue depth checks, retire bookkeeping, and drain semantics
  (`src/main/java/com/github/ulviar/icli/core/pool/PoolState.java`).
- Extracted invariant management into `PoolInventory`, isolating worker accounting (totals, idle queue, metrics) from
  the concurrency facade and exposing narrow updates with explicit signalling semantics
  (`src/main/java/com/github/ulviar/icli/core/pool/PoolInventory.java`).
- Refactored `ProcessPool` to delegate acquisitions, releases, drain, and minimum-size replenishment to `PoolState`,
  eliminating monitor fields and adopting the new outcomes for launch/lease workflows
  (`src/main/java/com/github/ulviar/icli/core/pool/ProcessPool.java`).
- Updated launch flows to reserve worker identifiers via `PoolState`, handle warmup failures through the new state API,
  and publish diagnostics/metrics driven by state changes.

## Tests & verification
- `gradle compileJava`
- `gradle test`
- `gradle integrationTest`
- `gradle spotlessApply`
- `gradle spotbugsMain`

## Documentation updates
- None required for this iteration; dossier already reflects ongoing ProcessPool refactors.

## Follow-up & risks
- Monitor for additional opportunities to push reset-hook defaults and client-facing diagnostics into future tasks now
  that the pool core is modularised.

## Retrospective & process improvement
- The extracted `PoolState` made it far easier to reason about invariants; future refactors should continue isolating
  concurrency-heavy logic behind narrow collaborators to keep `ProcessPool` readable.

---

- **Author:** Assistant
- **Lifecycle stage:** Execution
- **Summary:** Repartitioned pool coordination across `LifecycleGate`, `WaiterQueue`, and `CapacityLedger`, rewrote
  `PoolState` on top of the new collaborators, and updated `ProcessPool` plus timeout handling to consume the revised
  state outcomes.

## Implementation notes
- Added dedicated collaborators for lifecycle gating, waiter handoff, and capacity accounting
  (`src/main/java/com/github/ulviar/icli/core/pool/LifecycleGate.java`, `WaiterQueue.java`, `CapacityLedger.java`).
- Rebuilt `PoolState` to compose the new collaborators, return explicit deltas (retired workers, queue rejections,
  launch/release status), and enforce invariants under a fair lock
  (`src/main/java/com/github/ulviar/icli/core/pool/PoolState.java`).
- Updated `ProcessPool` to emit diagnostics outside the lock, manage active lease scopes, drive the new launch/release
  states, and route lease timeouts through the standard release pipeline
  (`src/main/java/com/github/ulviar/icli/core/pool/ProcessPool.java`, `DefaultWorkerLease.java`).
- Extended tests with focused coverage for the new collaborators and timeout semantics
  (`src/test/kotlin/com/github/ulviar/icli/core/pool/WaiterQueueTest.kt`, `CapacityLedgerTest.kt`,
  `LifecycleGateTest.kt`, `ProcessPoolTest.kt`) and adjusted integration tests to the new diagnostics flow.

## Tests & verification
- `gradle test`
- `gradle integrationTest`
- `gradle spotlessApply`
- `gradle spotlessCheck`
- `gradle spotbugsMain`

## Documentation updates
- Recorded the execution plan under
  [context/tasks/ICLI-015/execution-history/2025-10-28-plan.md](../../ICLI-015/execution-history/2025-10-28-plan.md).

## Follow-up & risks
- Monitor queue rejection diagnostics for accuracy now that they are emitted from `ProcessPool`.
- Consider additional diagnostics around waiter assignments if future clients need visibility.

## Retrospective & process improvement
- Maintaining an active-lease map simplified timeout handling; future features that need per-lease metadata should reuse
  this structure.
- Adding targeted unit tests for collaborators caught regressions early and should remain standard practice for
  concurrency refactors.
---

- **Author:** Assistant
- **Lifecycle stage:** Execution
- **Summary:** Applied pool-refactoring-4 recommendations by tightening worker inventory invariants, improving deadline
  handling, and capturing the updates in the pooled source bundle.

## Implementation notes
- Hardened `CapacityLedger` bookkeeping with assertion-guarded decrements and a shared helper that records retired idle
  workers while preserving invariant clarity (`src/main/java/com/github/ulviar/icli/core/pool/CapacityLedger.java`).
- Promoted `PoolWorker.retireRequested` to `volatile` and documented lock-based access via `@SuppressFBWarnings`,
  preventing SpotBugs regressions while keeping the concurrency model explicit
  (`src/main/java/com/github/ulviar/icli/core/pool/PoolWorker.java`).
- Reordered lease deadline cancellation to occur before removing the active lease entry and trimmed redundant waiter
  removals, matching the race fixes (`src/main/java/com/github/ulviar/icli/core/pool/ProcessPool.java`, `PoolState.
  java`).
- Ensured AcquireResult variants defensively copy retired-worker lists to avoid exposing internal state and refreshed
  `context/tasks/ICLI-015/pool-package-source.txt` with the latest package snapshot.

## Tests & verification
- `gradle spotlessApply`
- `gradle spotlessCheck`
- `gradle spotbugsMain`
- `gradle test`
- `gradle integrationTest`

## Follow-up & risks
- Optional clean-ups (single invariant assertions per method, diagnostics debouncing) remain candidates for later 
  iterations.

## Retrospective & process improvement
- Refreshing the aggregated pool source after each refactor keeps downstream reviewers aligned; scripting the export
  avoided manual mistakes and should remain part of the standard checklist.
---

- **Author:** Assistant
- **Lifecycle stage:** Execution
- **Summary:** Added FIFO regression coverage ensuring queued waiters receive idle workers before new arrivals.

## Implementation notes
- Introduced `idleWorkerPrefersQueuedWaitersOverNewArrivals` in
  `src/test/kotlin/com/github/ulviar/icli/core/pool/ProcessPoolTest.kt` to emulate two queued waiters and assert the
  acquisition order remains FIFO when an idle worker becomes available.

## Tests & verification
- `gradle test`
- `gradle spotlessApply`

## Follow-up & risks
- The fairness test relies on short sleeps for thread scheduling; if it flakes under stress we may swap the barrier for
  explicit instrumentation in the pool diagnostics.

## Retrospective & process improvement
- Explicit FIFO coverage gives quick feedback whenever wait queue logic changes; future concurrency tweaks should follow
  this pattern before adjusting production code.
