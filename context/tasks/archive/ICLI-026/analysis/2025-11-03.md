# Analysis Log — ICLI-026 — 2025-11-03

- **Author:** Assistant
- **Lifecycle stage:** Analysis
- **Context:** Establish the design scope for pooled command service APIs and gather the prior work that constrains the
  proposal.

## Knowledge consulted
- [context/tasks/backlog.md](/context/tasks/backlog.md) — Clarified the Definition of Done: deliver a written design for
  `PooledCommandService`, outline pooled runner roles, and record diagnostics/listener decisions inside the ICLI-016
  dossier.
- [context/tasks/archive/ICLI-016/analysis/2025-11-03.md](../../ICLI-016/analysis/2025-11-03.md) — Provided the
  maintainer-approved direction for splitting `CommandService` and introducing pooled runner types plus shared execution
  templates.
- [design/2025-11-03-pooled-command-service.md](../design/2025-11-03-pooled-command-service.md) — Houses the active
  design note this task must deliver, avoiding dependencies on archived outputs while detailing pooled services and
  shared runner requirements.
- [context/roadmap/process-pool-architecture.md](/context/roadmap/process-pool-architecture.md) — Reaffirmed pool-level
  contracts (lease lifecycle, reset hooks, diagnostics events) that the pooled facade must respect, especially around
  shutdown and metrics.
- [context/roadmap/execution-architecture-brief.md](/context/roadmap/execution-architecture-brief.md) — Highlighted
  Essential API expectations so the new facade preserves scenario coverage and avoids leaking advanced runtime concerns.

## Repository inspection
- `src/main/java/com/github/ulviar/icli/client/CommandService.java` — Confirmed how current runners are constructed,
  including default decoder wiring and the existing `pooled()` factory that returns `ProcessPoolClient`.
- `src/main/java/com/github/ulviar/icli/client/ProcessPoolClient.java` — Reviewed lifecycle ownership of `ProcessPool`,
  drain policy defaults, and the public entry points (`serviceProcessor`, `openConversation`, `pool`).
- `src/main/java/com/github/ulviar/icli/client/ServiceProcessor.java` & `ServiceConversation.java` — Assessed listener
  callbacks, reset sequencing, and how pooled helpers translate lease scope metadata, which informs required shared
  execution abstractions.
- `src/main/java/com/github/ulviar/icli/client/LineSessionRunner.java` & `CommandRunner.java` — Noted duplication in
  runner construction that future shared templates must absorb to keep pooled and non-pooled flows aligned.

## Gaps & questions
- Need agreement on package layout (e.g., `client.pooled`) and how the public surface references the design note before
  code changes land.
- Must decide how diagnostics listeners compose: should pooled runners accept overrides per runner, or inherit the
  facade-level listener with optional per-call augmentation?
- Clarify the migration path for `CommandService.pooled()` so existing callers receive the new facade without a breaking
  change (e.g., transitional delegation).

## Decision / readiness
- Ready to draft the design with the gathered references; no further research blockers identified.

## Next steps
- Populate the task dossier planning section with scope/risks.
- Author the design note under the ICLI-016 dossier, covering API shapes, package layout, and diagnostics strategy.
- Update backlog/dossier metadata once the design is captured.
