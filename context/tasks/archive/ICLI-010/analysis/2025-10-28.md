# Analysis Log — 2025-10-28

- **Lifecycle stage:** Planning
- **Author:** Assistant (Codex)

## Knowledge consulted
- [`context/roadmap/execution-architecture-brief.md`](../../roadmap/execution-architecture-brief.md) — Reaffirmed the
  expectation that streaming capture should be exposed through `OutputCapture.streaming()` with diagnostics/truncation
  events routed via the runtime bus; clarified that Essential APIs rely on these hooks for telemetry.
- [`context/roadmap/project-roadmap.md`](../../roadmap/project-roadmap.md) — Confirmed Phase 3/4 priority on core
  execution engine completeness, making streaming capture the next foundational backlog item before higher-level
  tooling.
- [`src/main/java/com/github/ulviar/icli/core/runtime/io/OutputSinkFactory.java`](../../../src/main/java/com/github/ulviar/icli/core/runtime/io/OutputSinkFactory.java)
  — Verified the current limitation that throws `UnsupportedOperationException` for streaming policies, identifying the
  entry point that needs extension.
- [`src/main/java/com/github/ulviar/icli/core/runtime/StandardProcessEngine.java`](../../../src/main/java/com/github/ulviar/icli/core/runtime/StandardProcessEngine.java)
  and
  [`src/main/java/com/github/ulviar/icli/core/runtime/io/VirtualThreadStreamDrainer.java`](../../../src/main/java/com/github/ulviar/icli/core/runtime/io/VirtualThreadStreamDrainer.java)
  — Reviewed how bounded sinks integrate with stream draining to ensure the streaming implementation fits without
  regressing deadlock prevention.

## Findings
- Streaming capture currently fails during sink creation and is explicitly asserted by `StandardProcessEngineTest`;
  implementing the feature will require both production code changes and corresponding test updates to validate
  successful streaming behaviour.
- Diagnostics hooks referenced in the roadmap do not yet exist; we need to decide whether to extend existing structures
  or introduce a dedicated event publisher as part of this task.
- Output truncation metadata is only implicitly observable through bounded capture strings; supporting diagnostics
  likely requires augmenting `OutputSink` to expose truncation state or events.

## Design outline
- Introduce a `DiagnosticsListener` functional interface plus sealed `DiagnosticsEvent` types (`OutputChunk`,
  `OutputTruncated`) with a `StreamType` discriminator, defaulting to a no-op implementation.
- Extend `ExecutionOptions` so callers can supply a diagnostics listener; pipe this through `StandardProcessEngine` into
  `OutputSinkFactory`.
- Update `OutputSinkFactory` to build sinks with diagnostics context. `BoundedOutputSink` will emit `OutputTruncated`
  when capacity is exceeded, while a new `StreamingOutputSink` forwards every chunk as an `OutputChunk` event and leaves
  `content()` empty.
- Modify `StandardProcessEngine` tests to drive the new behaviour (streaming capture succeeds, diagnostics receive
  events). Additional unit tests will cover the sink implementations directly.

## Readiness decision
Additional design work is needed before execution: define the diagnostics interface and streaming sink behaviour. Once
the design outline is captured (next step), implementation can proceed under TDD.
