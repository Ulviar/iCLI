# Analysis Log — ICLI-009 — 2025-10-26

- **Author:** Assistant (Codex)
- **Lifecycle stage:** Analysis
- **Context:** Establish scope and prerequisites for implementing PTY-backed interactive sessions per roadmap Phase 4.

## Knowledge consulted
- [project-roadmap.md](../../roadmap/project-roadmap.md) — Confirms Phase 4 begins with implementing interactive session
  API, making this task the gating item before expect-style helpers or pooling work.
- [execution-architecture-brief.md](../../roadmap/execution-architecture-brief.md) — Details the Essential vs Advanced
  API split, expected semantics for `CommandService.interactiveSessionRunner()`, handle capabilities, PTY fallback
  rules, and timeout/diagnostics expectations the engine must honour.
- [Java Terminal & Process Integration
  KB](../../knowledge-base/operations/Java%20Terminal%20%26%20Process%20Integration.md) — Provides operational guidance
  for PTY vs pipe launches, Ctrl+C handling, PTY sizing defaults, and IO pumping pitfalls that inform the implementation
  plan.

## Repository inspection
- `src/main/java/com/github/ulviar/icli/core/runtime/StandardProcessEngine.java` — Currently only implements `run(...)`
  and explicitly throws on `startSession(...)`, so new runtime collaborators and PTY plumbing are required; the existing
  constructor already wires `CommandLauncher`, `OutputSinkFactory`, `StreamDrainer`, and `ShutdownExecutor` that can
  likely be reused for session IO pumps.
- `src/main/java/com/github/ulviar/icli/core/runtime/launch/PipeCommandLauncher.java` & `CommandLauncher` — Only support
  pipe-based `ProcessBuilder` launches and reject `TerminalPreference.REQUIRED`, meaning we need a PTY-aware launcher
  implementation plus selection logic.
- `src/main/java/com/github/ulviar/icli/core/runtime/io/*` — Stream draining and bounded sinks exist for single-run
  capture; interactive sessions should reuse `StreamDrainer` for stdout/stderr pumps feeding directly into user-facing
  streams.

## Gaps & questions
- How should PTY availability be detected/configured (e.g., feature flag vs dependency presence) within the launcher
  abstraction?
- What is the minimal viable `InteractiveSession` implementation (plain process handle vs wrapper type) before Essential
  API adapters are layered on?
- Deterministic PTY test strategy: can we rely on pty4j in CI, or do we need conditional tests/fakes to avoid platform
  issues?

## Decision / readiness
Execution planning can proceed with the current information; outstanding questions will be resolved during design of the
launcher abstraction and test scaffolding.

## Next steps
- Design PTY-capable `CommandLauncher` implementation and selection logic based on `TerminalPreference`.
- Sketch interactive session handle structure (wrapping stdin/stdout/stderr plus lifecycle controls) and determine reuse
  of `StreamDrainer`.
- Outline test plan covering PTY vs pipe behaviour and timeout/shutdown semantics.
