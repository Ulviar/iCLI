# Analysis Log — ICLI-016 — 2025-11-03

- **Author:** Assistant
- **Lifecycle stage:** Analysis
- **Context:** Capture the refactor direction for pooled APIs so work can be split into focused follow-up tasks.

## Vision for pooled API refactor

- Keep `CommandService` as a thin facade exposing scenario-oriented runners (command, line session, interactive). It
  must not accumulate additional state beyond the existing runners.
- Introduce `PooledCommandService` that mirrors the `CommandService` surface but injects pool configuration per runner
  call and returns specialised `Pooled*Runner` types. Each pooled runner delegates to shared execution primitives while
  handling lease lifecycle, diagnostics, and pool controls.
- Design the refactor so both non-pooled and pooled runners share lower-level collaborators (e.g.,
  `CommandInvocationTemplate`, `LineInteractionTemplate`) instead of duplicating orchestration logic.
- Position the new structure to grow scenario-specific runners (e.g., MCP runner, listenable runner) without
  cross-contaminating concerns between pooled and non-pooled flows.

## Proposed task breakdown

1. **API design & documentation**
   - Draft a short design note describing `PooledCommandService`, `PooledCommandRunner`, and shared collaborators.
   - Define migration/compatibility strategy (e.g., `CommandService.pooled()` temporarily returns the new facade).
   - Update roadmap/dossier with the agreed end-state.

2. **Shared execution layer extraction**
   - Identify common logic in existing runners and extract reusable components.
   - Add unit tests for the new components to protect behaviour during later refactors.

3. **Implement pooled service facade**
   - Introduce `PooledCommandService` and pooled runner types.
  - Wire pooled runners to `ProcessPool` via new shared templates, ensuring diagnostics/reset hooks remain policy
  compliant.
   - Update `CommandService.pooled()` to delegate to the new facade.

4. **Scenario runner alignment**
   - Audit existing runner usage and plan future scenario-specific runners.
   - Adjust documentation and examples to highlight both standard and pooled scenarios.

5. **Cleanup & follow-up**
   - Deprecate direct `ProcessPoolClient` exposure if superseded by pooled runners (or reposition it as an advanced
   entry point).
   - Ensure task dossiers, tests, and documentation reflect the final structure.

## Notes & open questions

- Decide whether `PooledCommandService` lives in the same package or a dedicated `client.pooled` subpackage to emphasise
  isolation.
- Determine how diagnostics listeners are injected for pooled versus standard runners (single listener per facade vs
  per-runner overrides).
- Confirm whether pooled runners should expose additional controls (e.g., manual lease reset) or rely solely on scenario
  helpers.
