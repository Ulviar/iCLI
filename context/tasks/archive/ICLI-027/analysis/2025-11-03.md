# Analysis Log — ICLI-027 — 2025-11-03

- **Author:** Assistant
- **Lifecycle stage:** Analysis
- **Context:** Prepare the refactor that extracts a shared runner execution core for both standard and forthcoming
  pooled services.

## Knowledge consulted
- [context/tasks/ICLI-026/design/2025-11-03-pooled-command-service.md](../ICLI-026/design/2025-11-03-pooled-command-service.md)
  — Defines the shared abstractions (`RunnerDefaults`, `CommandCallFactory`, `SessionLauncher`, `LineSessionFactory`)
  that this task must deliver so `PooledCommandService` can reuse the standard runner logic.
- [context/tasks/ICLI-026/analysis/2025-11-03.md](../ICLI-026/analysis/2025-11-03.md) — Captures the earlier
  investigation into current runner duplication and the migration requirements, confirming alignment with the new
  design.
- [context/tasks/backlog.md](../backlog.md) — Restated Definition of Done and dependencies, ensuring this refactor
  preserves existing behaviour while enabling ICLI-028.

## Repository inspection
- `src/main/java/com/github/ulviar/icli/client/CommandService.java` — Identified repeated construction of `CommandCall`
  defaults and decoder wiring for each runner, indicating target logic for shared helpers.
- `src/main/java/com/github/ulviar/icli/client/CommandRunner.java` — Noted local helper methods (`createBaseCall`,
  `buildCustomCall`) that duplicate behaviour across other runners; candidate for extraction into a shared factory.
- `src/main/java/com/github/ulviar/icli/client/LineSessionRunner.java` & `InteractiveSessionRunner.java` — Confirmed
  similar duplication plus reliance on `InteractiveSessionStarter`, informing the need for an injectable session
  launcher abstraction.
- `src/main/java/com/github/ulviar/icli/client/InteractiveSessionStarter.java` — Reviewed PTY fallback handling to
  evaluate how a shared `SessionLauncher` interface can encapsulate this behaviour without exposing internals to pooled
  runners.
- `src/main/java/com/github/ulviar/icli/client/ServiceProcessor.java` & `ServiceConversation.java` — Validated that
  upcoming pooled runners will reuse line/interactive session helpers, reinforcing the requirement for a shared
  `LineSessionFactory`.
- Tests — No existing Kotlin tests cover the runners; new unit coverage will need to be introduced alongside the
  refactor to guard behaviour.

## Gaps & questions
- Determine the module/package arrangement for the new shared helpers so production code can access them while keeping
  the API internal (likely `com.github.ulviar.icli.client.internal.runner`). Need to confirm test visibility within the
  JPMS module.
- Decide on the minimal set of new unit tests (probably focus on `CommandRunner` redirection to shared helpers plus
  dedicated tests for the new factory classes).
- Clarify whether any behaviour relies on overriding the default `ResponseDecoder` per service; ensure the shared layer
  permits future pooled runners to customise decoders without duplicating logic.

## Decision / readiness
- Ready to draft the implementation plan: refactor existing runners to reuse new internal helpers while preserving
  behaviour and prepare tests to validate the shared core.

## Next steps
- Draft the detailed implementation approach (class list, package layout, testing strategy).
- Sketch test cases covering the shared factory behaviour and regression protection for current runners.
- Confirm module/package configuration to keep internal helpers non-exported while accessible to tests.
