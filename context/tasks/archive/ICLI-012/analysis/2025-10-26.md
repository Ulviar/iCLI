# Analysis Log — ICLI-012 — 2025-10-26

- **Author:** Assistant (Codex)
- **Lifecycle stage:** Analysis
- **Context:** Outline the implementation approach for ClientScheduler, async helpers, and coroutine adapters before
  modifying code.

## Knowledge consulted
- [Execution architecture brief](/context/roadmap/execution-architecture-brief.md) — Defines the hybrid modality plan
  (blocking core + ClientScheduler + async helpers) and lists the components that must adopt the scheduler
  (CommandService, LineSessionClient, ProcessPoolClient). Guides the scope and naming of new APIs.
- [Coding standards](/context/guidelines/coding/standards.md) — Reiterates documentation, nullability, and TDD
  expectations; informs how new Java types (ClientScheduler) must be annotated and documented.
- [Assistant notes](/context/guidelines/icli/assistant-notes.md) — Emphasises record usage, documentation, and
  test-first process; confirms virtual-thread preference for IO pumps aligns with using them in the scheduler.
- [CommandServiceTest](/src/test/kotlin/com/github/ulviar/icli/client/CommandServiceTest.kt) & existing client sources —
  Establish current behaviour to extend (blocking helpers only), highlight where scheduler injection has to happen, and
  show available test doubles (RecordingExecutionEngine, ScriptedInteractiveSession).

## Repository inspection
- Reviewed `CommandService`, `LineSessionClient`, `InteractiveSessionClient`, and supporting client tests to inventory
  existing APIs and determine change points.
- Checked `build.gradle.kts` to confirm Kotlin main sources are allowed and to identify where new coroutine dependencies
  must be declared.

## Gaps & questions
- Need to decide how ownership of the default scheduler is managed (per-service vs shared singleton) to avoid leaking
  executors; leaning toward per-service scheduler with opt-in custom injection plus a boolean flag for ownership.
- Must choose a coroutine dependency version without internet access; plan to use the latest known stable (1.8.1) and
  document the rationale unless maintainer prefers an override.
- Future ProcessPoolClient async helpers are out of scope for this task (pool not yet implemented); we need to confirm
  whether to add placeholder methods or defer until the pool exists.

## Decision / readiness
- Ready to start implementation with the outlined scope: build ClientScheduler + default implementation, extend
  CommandService/LineSessionClient, add coroutine adapters, and update tests/dependencies.

## Next steps
1. Implement `ClientScheduler` abstraction plus virtual-thread-backed default with cancel-aware futures.
2. Update `CommandService` and `LineSessionClient` to accept/use the scheduler and add async methods.
3. Add Kotlin coroutine extensions (`runSuspend`, `processSuspend`) using completable future bridging.
4. Write/adjust tests verifying scheduler cancellation, async behaviour, and coroutine adapters; run Spotless/tests.
