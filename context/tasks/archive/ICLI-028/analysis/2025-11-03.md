# Analysis Log — ICLI-028 — 2025-11-03

- **Author:** Assistant
- **Lifecycle stage:** Planning
- **Context:** Initialise the PooledCommandService facade task and confirm scope/constraints before implementation.

## Knowledge consulted
- [../archive/ICLI-026/design/2025-11-03-pooled-command-service.md](../archive/ICLI-026/design/2025-11-03-pooled-command-service.md)
  — Provides the target facade layout, runner responsibilities, and migration expectations we must honour.
- [../archive/ICLI-027/README.md](../archive/ICLI-027/README.md) and
  [../archive/ICLI-027/analysis/2025-11-03.md](../archive/ICLI-027/analysis/2025-11-03.md) — Confirm the shared runner
  abstractions now available (`RunnerDefaults`, `CommandCallFactory`, `LineSessionFactory`, `SessionLauncher`) so pooled
  runners can reuse standard logic.
- [../../..//src/main/java/com/github/ulviar/icli/client/CommandService.java](../../../src/main/java/com/github/ulviar/icli/client/CommandService.java)
  — Reviewed existing factory methods, default wiring, and backward-compatible `pooled()` helpers that must coexist with
  the new facade.
- [../../../src/main/java/com/github/ulviar/icli/client/ProcessPoolClient.java](../../../src/main/java/com/github/ulviar/icli/client/ProcessPoolClient.java),
  [../../../src/main/java/com/github/ulviar/icli/client/ServiceProcessor.java](../../../src/main/java/com/github/ulviar/icli/client/ServiceProcessor.java),
  and
  [../../../src/main/java/com/github/ulviar/icli/client/ServiceConversation.java](../../../src/main/java/com/github/ulviar/icli/client/ServiceConversation.java)
  — Assessed pool lifecycle, listener sequencing, and async helpers to ensure the pooled runners delegate correctly
  without duplicating logic.
- [../../../src/main/java/com/github/ulviar/icli/client/internal/runner/](../../../src/main/java/com/github/ulviar/icli/client/internal/runner/)
  — Verified the new shared helper implementations we will compose inside the pooled facade.

## Findings
- The design expects `PooledCommandService` to own a single `ProcessPoolClient`, mirroring `CommandService` constructors
  and exposing new runner types that internally cache helpers (including a `ServiceProcessor`).
- Shared runner infrastructure from ICLI-027 removes most duplication; pooled runners should primarily focus on lease
  acquisition (`ProcessPoolClient.serviceProcessor()` / `openConversation()`) while delegating decoding and scheduling
  to existing factories.
- Backward compatibility is required: `CommandService.pooled()` must continue to return ad-hoc clients for callers that
  prefer manual management, while the new facade offers a higher-level alternative.
- Tests will need focused coverage for facade construction, pooled runner behaviour (including async helpers), listener
  invocation, and proper pool shutdown via `AutoCloseable`.

## Risks / open questions
- Need to determine how to surface `LineSessionClient` and `InteractiveSessionClient` without leaking direct access to
  `ProcessPoolClient` internals; design suggests new wrapper interfaces but existing helper API may suffice.
- Must ensure pooled runners avoid repeatedly instantiating `ServiceProcessor` or leaking leases when exceptions occur.
- JPMS visibility for new classes must be validated, especially if pooled runners live under `client.pooled` package as
  proposed in ICLI-026.

## Readiness decision
- Ready to proceed with detailed planning and test design; no further research required at this stage.
