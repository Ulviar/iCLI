# Analysis Log — ICLI-016 — 2025-11-02

- **Author:** Assistant
- **Lifecycle stage:** Analysis
- **Context:** Explore pooled API options that satisfy both stateless request processors and stateful interactive
  sessions before drafting implementation work.

## Knowledge consulted
- [context/roadmap/execution-architecture-brief.md](/context/roadmap/execution-architecture-brief.md) — Confirmed the
  Essential API aspirations for `ProcessPoolClient`, `ServiceProcessor`, and the split between simple request helpers
  and lease-driven access.
- [context/roadmap/process-pool-architecture.md](/context/roadmap/process-pool-architecture.md) — Provided the advanced
  API contracts (ProcessPool, WorkerLease, diagnostics) that pooled clients must expose or wrap without breaking
  invariants.
- [context/research/icli-execution-engine-benchmarks.md](/context/research/icli-execution-engine-benchmarks.md) —
  Highlighted industry patterns (lack of built-in pooling, emphasis on reset/diagnostics) reinforcing the need for
  explicit session-reset hooks and observability in the Essential API.
- [context/research/experiments/kotlin-solution-audit.md](/context/research/experiments/kotlin-solution-audit.md) —
  Captured pitfalls from the legacy pool (single-command restriction, weak reset semantics) that the new API must avoid
  by design.

## Repository inspection
- `src/main/java/com/github/ulviar/icli/client/CommandService.java` and related runners — Established the current
  Essential API surface, async scheduler usage, and per-call customisation mechanics (`CommandCallBuilder`,
  `ResponseDecoder`).
- `src/main/java/com/github/ulviar/icli/core/pool/api/*.java` — Reviewed ProcessPool runtime capabilities (lease
  semantics, config defaults, diagnostics, reset hooks) to understand what can be safely exposed to clients.
- `src/main/java/com/github/ulviar/icli/client/LineSessionClient.java` & `InteractiveSessionClient.java` — Identified
  how existing session wrappers manage ownership and why pooled variants must not call `close()` on the underlying
  session when returning leases.

## Proposed API direction
- Introduce `CommandService#pooled(...)` factory overloads returning a `ProcessPoolClient` that owns pool lifecycle and
  surfaces both stateless (`ServiceProcessor`) and stateful (`ConversationManager`) entry points while allowing access
  to the underlying `ProcessPool`, metrics, and diagnostics listener wiring.
- Model stateless workloads through `ServiceProcessor.process(...)` / `processAsync(...)` helpers that borrow a lease
  per call, execute a `CommandCall` using a pooled `LineSessionClient`, and automatically reset/return the worker.
  Support optional payload codecs (`String`, `byte[]`, custom) and per-request overrides via `CommandCallBuilder`.
- Provide stateful workflows via `ServiceProcessor.openConversation(...)` (returns `ServiceConversation` bound to a
  single `WorkerLease`) and targeted borrow helpers such as `ProcessPoolClient.lineConversations().borrow()` or
  `interactiveConversations().borrowAsync(...)`. The conversation exposes `LineSessionClient`-style helpers, direct
  `InteractiveSessionClient` access, scope metadata, manual `reset(...)`, and explicit disposal that retires unhealthy
  workers before returning them.
- Allow optional affinity keys when opening conversations to pin a worker across reopenings without holding the lease
  indefinitely, enabling session stickiness for clients like `ollama` while still supporting fair scheduling.
- Ensure diagnostics are pluggable by attaching a `ServiceProcessorListener` that decorates the existing
  `PoolDiagnosticsListener` with service-level events (request start/finish, reset outcome, timeout) without leaking
  internal state changes.

## Gaps & questions
- Need to define whether conversation-level APIs should support affinity keys (pinning without holding the lease) or
  require explicit `openConversation()` handles.
- Clarify how much of `ProcessPool` diagnostics should surface directly through the Essential API versus a new listener
  SPI tailored to service-level events.

## Decision / readiness
- Ready to draft API proposals; no further research required before outlining design options for pooled clients.

## Next steps
- Formalise the proposed `ProcessPoolClient`, `ServiceProcessor`, and conversation APIs (stateless vs stateful) and
  review them with stakeholders.
- Capture the proposal inside the ICLI-016 dossier and prepare feedback for the maintainer.
